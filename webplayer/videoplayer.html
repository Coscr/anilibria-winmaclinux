<!DOCTYPE html>
<html lang="en" style="height:100%;">
	<head>
		<meta charset="utf-8">
		<title>Remote web player</title>
		<script src="https://cdn.jsdelivr.net/npm/@clappr/player@latest/dist/clappr.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/vue@2.6.12"></script>
	</head>
	<style>
		.video-player {
			margin-top: 20px;
			display:flex;
			align-items: center;
			justify-content: center;
		}
		.form-container {
			width: 300px;
			display:flex;
			align-items: center;
			justify-content: center;
			flex-direction: column;
			padding: 10px;
		}
		.form-row-container {
			display:flex;
			justify-content: center;
		}
		.form-container input {
			margin-bottom: 4px;
			width: 100%;
		}
		.form-title {
			align-self: flex-start;
			display: flex;
			flex-direction: row;
			justify-content: flex-start;
			font-size: 16px;
			font-weight: bold;
		}
	</style>
	
	<body>
		<div id="app">
			<div class="form-row-container">
				<div class="form-container">
					<div class="form-title">
						<span>
							Адрес
						</span>
					</div>
					<input
						type="text"
						v-model="host"
						placeholder="Введите хост в виде ip адреса или имени"
					/>
					<div class="form-title">
						<span>
							Порт
						</span>
					</div>
					<input
						type="text"
						v-model="port"
						placeholder="Введите порт в виде числа 100-65535"
					/>
					<button
						@click="connectToHost()">
						Подключиться
					</button>
				</div>
			</div>
			<div class="video-player">
			</div>		
		</div>
		<script>
			new Vue(
				{
					el: `#app`,
					data: {
						videoSource: ``,
						host: ``,
						port: 12345,
						socket: null,
						connected: false,
						pingTimeoutId: null,
						player: null
					},
					methods: {
						loadToPlayer(videoSource) {
							if (!this.player) {
								this.player = new Clappr.Player(
									{
										source: videoSource,
										autoPlay: true,
										parentId: ".video-player"
									}
								);
								return;
							}
							
							this.player.load(videoSource);
						},
						setVideoSource(videoSource) {
							console.log(`setVideoSource`, videoSource);
							if (this.videoSource === videoSource) return;
							
							this.videoSource = videoSource;
							this.loadToPlayer(videoSource);
						},
						setVideoPosition(position) {
							console.log(`setVideoPosition`, position);
							this.player.seek(position);
						},
						setVolume(volume) {
							const volumeDigit = parseInt(volume) / 100;
							console.log(`setVolume`, volumeDigit);
							this.player.setVolume(volumeDigit);
						},						
						setPlaybackRate(playbackRate) {
							console.log(`setPlaybackRate`, playbackRate);
							debugger;
							player.core.activePlayback.el.playbackRate = parseFloat(playbackRate);
						},						
						setPlayback(playback) {
							console.log(`setPlayback`, playback);
							switch (playback) {
								case `pause`:
									this.player.pause();
									break;
								case `play`:
									this.player.play();
									break;
							}
						},
						clearPingTimeout() {
							if (this.pingTimeoutId) clearTimeout(this.pingTimeoutId);
						},
						setPingTimeout(socket) {
							this.pingTimeoutId = setTimeout(
								() => {
									this.socket.send(`ping`);
									
									this.setPingTimeout(socket);
								},
								10000
							);
						},
						async connectToHost() {
							if (!this.host || !this.port) return; //show error message
							
							this.socket = new WebSocket(`ws://${this.host}:${this.port}`);

							this.socket.onclose = function() {
								console.log("web channel closed");
								this.clearPingTimeout();
								this.connected = false;
							};
							this.socket.onerror = function(error) {
								console.error("web channel error: " + error);
							};
							this.socket.onopen = () => {
								console.log("socket opened ");
								this.connected = true;
								
								this.setPingTimeout(this.socket);

								setTimeout(
									() => {
										this.socket.send(`getcurrentvideosource`);
									},
									100
								);
							};
							this.socket.onmessage = (event) => {
								console.log(`message`, event.data);
								const message = event.data;

								if (message[0] === `{`) throw `Json commands don't supported!`;

								const parts = message.split(`::`).filter(a => a);
								if (!parts.length) throw `Unknown or empty command!`;

								const command = parts[0];
								const firstArgument = parts[1];

								switch (command) {
									case `positionchanged`:
										if (!firstArgument) throw `Command positionchanged need int argument (positionchanged::1212)`;
										
										this.setVideoPosition(parseInt(firstArgument));
										break;
									case `videosourcechanged`:
										if (!firstArgument) throw `Command videosourcechanged need string argument (videosourcechanged::http://video)`;
										
										this.setVideoSource(firstArgument);
										break;

									case `volumechanged`:
										if (!firstArgument) throw `Command volumechanged need int argument (volumechanged::50)`;
										
										this.setVolume(firstArgument);
										break;
									case `playbackratechanged`:
										if (!firstArgument) throw `Command playbackratechanged need double argument (playbackratechanged::1)`;
										
										this.setPlaybackRate(firstArgument);
										break;
									case `playbackchanged`:
										if (!firstArgument) throw `Command playbackchanged need string argument (playbackchanged::play)`;
										
										this.setPlayback(firstArgument);
										break;
								}
							};
						}
					}
				}
			);
		</script>
	</body>	
</html>